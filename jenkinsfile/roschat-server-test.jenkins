#!groovy

def SERVER_VER="${params.VER}"

properties([disableConcurrentBuilds()])

pipeline{
    agent {
        label ''
    }
    stages{
        stage("Cleaning the build directory"){
            steps{
                deleteDir();
            }
        }
        stage("Cloning from a git repository"){
            steps{
                script{
                    try{
                        git 'ssh://bezpalko_p@10.10.199.35/opt/git/firelink/test-roschat-ms'
                    }catch(err){
                        currentBuild.result = "FAILURE"
                        error("Error copying from git repository")
                    }
                }
            }
        }
        stage("Testing"){
            steps{
                script{
                    try{
                        sh './gradlew clean test_roschatserver -Dhost="testing2.ros.chat" -Dport="1110"'
                    }catch(err){
                        currentBuild.result = 'FAILURE';
                    }
                }
            }
        }
        stage("Report creating"){
            steps{
                allure includeProperties: false, jdk: '', results: [[path: 'build/allure-results']]
            }
        }
        stage("Running web-client testing"){
            steps{
                script{
                    try{
                        sleep 60
                        build(job: "roschat-web-client-testing",
                            parameters: [
                                string(name: 'VER', value: "${SERVER_VER}"),
                                string(name: 'REZULT', value: "${currentBuild.result}"),
                                string(name: 'REPORT', value: "${BUILD_URL}allure")
                            ])
                    }catch(err){
                        error('web-client testing - FAILED')
						currentBuild.result = 'FAILURE'
                    }
                }
            }

        }
    }
}